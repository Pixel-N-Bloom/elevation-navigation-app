<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#2563eb" />
    <meta name="description" content="Navigate with elevation awareness for COPD and respiratory health" />
    
    <!-- PWA Meta Tags for iPhone -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Elevation Navigation" />
    
    <title>Elevation Navigation</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            background: #2563eb;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .status-card {
            margin: 1rem;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        
        .elevation-safe {
            background: #f0fdf4;
            border-color: #16a34a;
            color: #16a34a;
        }
        
        .elevation-warning {
            background: #fffbeb;
            border-color: #d97706;
            color: #d97706;
        }
        
        .elevation-danger {
            background: #fef2f2;
            border-color: #dc2626;
            color: #dc2626;
        }
        
        .elevation-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        
        .section {
            margin: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        button {
            padding: 0.75rem 1rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
        }
        
        button:hover {
            background: #1d4ed8;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .route-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }
        
        .route-recommended {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        
        .route-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #6b7280;
            margin: 0.5rem 0;
        }
        
        .elevation-profile {
            display: flex;
            height: 2rem;
            gap: 2px;
            margin-top: 0.5rem;
        }
        
        .elevation-bar {
            flex: 1;
            background: #3b82f6;
            border-radius: 2px 2px 0 0;
        }
        
        .elevation-bar.danger {
            background: #ef4444;
        }
        
        .nav-status {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2563eb;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .hidden {
            display: none;
        }
        
        .pwa-banner {
            background: #16a34a;
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .badge {
            background: #16a34a;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 0.5rem;
        }
        
        .status-connected { background: #16a34a; }
        .status-connecting { background: #f59e0b; }
        .status-error { background: #dc2626; }
        
        /* Map Styles */
        .map-container {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        
        .map-toggle-btn {
            width: 100%;
            padding: 0.75rem;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .map-toggle-btn:hover {
            background: #e5e7eb;
        }
        
        /* Full screen map */
        .map-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            background: white;
        }
        
        .map-fullscreen-content {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .map-fullscreen .map-container {
            flex: 1;
            height: auto;
            border-radius: 0;
        }
        
        .directions-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-top: 2px solid #e5e7eb;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .next-direction {
            background: #2563eb;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .upcoming-directions {
            max-height: 120px;
            overflow-y: auto;
        }
        
        .direction-step {
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }

        /* Hide Leaflet Routing Machine controls */
        .leaflet-routing-container {
            display: none;
        }
    </style>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine JavaScript -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
</head>
<body>
    <div class="container">
        <!-- PWA Banner -->
        <div id="pwa-banner" class="pwa-banner">
            Tap Safari's share button, then "Add to Home Screen" for full app experience
        </div>

        <!-- Header -->
        <div class="header">
            <h1>Elevation Navigation</h1>
            <div style="font-size: 0.9rem; opacity: 0.9;">
                <span id="pwa-mode">Web Mode</span> ‚Ä¢ 
                <span id="gps-status">GPS: Connecting...</span>
                <span id="status-dot" class="status-indicator status-connecting"></span>
            </div>
        </div>

        <!-- Current Elevation Status -->
        <div id="elevation-status" class="status-card elevation-safe">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <strong>Current Location</strong>
                    </div>
                    <div id="current-city" style="font-size: 1rem; color: #4b5563; margin-bottom: 0.5rem;">Los Angeles, CA</div>
                    <div id="elevation-value" class="elevation-value">285 ft</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">
                        Max safe: <span id="threshold-value">8000</span> ft
                    </div>
                </div>
                <div id="warning-icon" class="hidden" style="font-size: 2rem;">‚ö†Ô∏è</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="section">
            <h3 style="margin-bottom: 0.5rem;">Quick Actions</h3>
            <button onclick="getCurrentLocation()" style="width: 100%; margin-bottom: 0.5rem;">
                Update Current Location
            </button>
            <button onclick="setElevationThreshold()" style="width: 100%;">
                Set Elevation Limit
            </button>
        </div>

        <!-- Interactive Map Section -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>Navigation Map</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="toggleMapSize()" id="map-size-btn" class="map-toggle-btn hidden" style="width: auto; margin: 0; padding: 0.5rem 1rem;">
                        Expand Map
                    </button>
                    <button onclick="toggleMap()" id="map-toggle-btn" class="map-toggle-btn" style="width: auto; margin: 0; padding: 0.5rem 1rem;">
                        Hide Map
                    </button>
                </div>
            </div>
            <div id="map-section">
                <div id="map" class="map-container"></div>
                <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem; text-align: center;">
                    Road routing powered by OpenStreetMap
                </div>
            </div>
        </div>

        <!-- Destination Input -->
        <div class="section">
            <h3 style="margin-bottom: 0.5rem;">Plan Route</h3>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Destination:</label>
            <div class="input-group">
                <input type="text" id="destination" placeholder="Enter destination address...">
                <button onclick="calculateRoutes()">Calculate</button>
            </div>
        </div>

        <!-- Route Options -->
        <div id="routes-section" class="hidden">
            <div style="margin: 1rem;">
                <h3 style="margin-bottom: 1rem;">Route Options</h3>
                <div id="routes-container"></div>
            </div>
        </div>

        <!-- Turn-by-Turn Directions -->
        <div id="directions-section" class="hidden">
            <div style="margin: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Turn-by-Turn Directions</h3>
                    <button onclick="printDirections()" style="padding: 0.5rem 1rem; background: #059669;">
                        Print Directions
                    </button>
                </div>
                <div id="directions-container"></div>
            </div>
        </div>

        <!-- Navigation Status -->
        <div id="nav-status" class="nav-status hidden">
            <div>
                <div style="font-weight: bold;">Navigating...</div>
                <div style="font-size: 0.9rem;">Following lowest elevation route</div>
            </div>
            <button onclick="stopNavigation()" style="background: #dc2626;">Stop</button>
        </div>
    </div>

    <script>
        console.log('Elevation Navigation starting...');
        
        // App State
        var state = {
            currentLocation: { lat: 34.0522, lng: -118.2437, elevation: 285 },
            currentCity: 'Los Angeles, CA',
            elevationThreshold: 8000,
            destination: '',
            routes: [],
            isNavigating: false,
            gpsStatus: 'connecting',
            isPWA: false,
            map: null,
            mapVisible: true,
            mapFullscreen: false,
            routingControl: null,
            selectedRoute: null,
            currentDirections: null,
            currentStep: 0
        };

        // Initialize app
        function init() {
            console.log('App initializing...');
            
            // Check PWA status
            checkPWA();
            
            // Load saved data
            loadSavedData();
            
            // Initialize GPS
            initGPS();
            
            // Initialize map automatically
            setTimeout(function() {
                initializeMap();
            }, 500);
            
            // Update display

            
            console.log('App initialized');
        }

        function checkPWA() {
            var isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                       window.navigator.standalone === true;
            
            state.isPWA = isPWA;
            
            if (isPWA) {
                document.getElementById('pwa-banner').style.display = 'none';
                document.getElementById('pwa-mode').textContent = 'PWA Mode';
            }
        }

        function loadSavedData() {
            try {
                var saved = localStorage.getItem('elevation_nav_data');
                if (saved) {
                    var data = JSON.parse(saved);
                    state.elevationThreshold = data.threshold || 8000;
                    console.log('Loaded saved data');
                }
            } catch (e) {
                console.log('Could not load saved data');
            }
        }

        function saveData() {
            try {
                var data = {
                    threshold: state.elevationThreshold
                };
                localStorage.setItem('elevation_nav_data', JSON.stringify(data));
            } catch (e) {
                console.log('Could not save data');
            }
        }

        function setElevationThreshold() {
            var newThreshold = prompt('Enter your safe elevation limit in feet:', state.elevationThreshold);
            if (newThreshold && !isNaN(newThreshold)) {
                state.elevationThreshold = parseInt(newThreshold);
                saveData();
                updateDisplay();
                console.log('Elevation threshold updated to:', state.elevationThreshold);
            }
        }

        function initGPS() {
            if ('geolocation' in navigator) {
                state.gpsStatus = 'connecting';
                updateDisplay();
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        state.currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            elevation: position.coords.altitude ? position.coords.altitude * 3.28084 : 285
                        };
                        state.gpsStatus = 'connected';
                        
                        // Get city name from coordinates
                        getCityFromCoordinates(state.currentLocation.lat, state.currentLocation.lng);
                        
                        // Update map if visible
                        updateMapLocation();
                        
                        updateDisplay();
                        console.log('GPS connected:', state.currentLocation);
                    },
                    function(error) {
                        state.gpsStatus = 'error';
                        updateDisplay();
                        console.log('GPS error:', error);
                        
                        if (error.code === error.PERMISSION_DENIED) {
                            alert('Please enable location access in Settings > Safari > Location Services for GPS functionality.');
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                state.gpsStatus = 'error';
                updateDisplay();
                alert('GPS not available on this device');
            }
        }

        function getCityFromCoordinates(lat, lng) {
            console.log('Getting city name for coordinates:', lat, lng);
            
            // Mock city data based on approximate coordinates
            var cityData = getCityFromCoords(lat, lng);
            
            if (cityData) {
                state.currentCity = cityData;
                document.getElementById('current-city').textContent = cityData;
                console.log('City updated to:', cityData);
            }
        }

        function getCityFromCoords(lat, lng) {
            // Approximate city lookup based on coordinates
            var cities = [
                { name: 'Los Angeles, CA', lat: 34.0522, lng: -118.2437, range: 0.5 },
                { name: 'San Francisco, CA', lat: 37.7749, lng: -122.4194, range: 0.3 },
                { name: 'Denver, CO', lat: 39.7392, lng: -104.9903, range: 0.4 },
                { name: 'Seattle, WA', lat: 47.6062, lng: -122.3321, range: 0.3 },
                { name: 'Phoenix, AZ', lat: 33.4484, lng: -112.0740, range: 0.4 },
                { name: 'Chicago, IL', lat: 41.8781, lng: -87.6298, range: 0.4 },
                { name: 'New York, NY', lat: 40.7128, lng: -74.0060, range: 0.3 },
                { name: 'Miami, FL', lat: 25.7617, lng: -80.1918, range: 0.3 },
                { name: 'Las Vegas, NV', lat: 36.1699, lng: -115.1398, range: 0.3 },
                { name: 'Salt Lake City, UT', lat: 40.7608, lng: -111.8910, range: 0.3 },
                { name: 'Portland, OR', lat: 45.5152, lng: -122.6784, range: 0.3 }
            ];
            
            // Find closest city
            for (var i = 0; i < cities.length; i++) {
                var city = cities[i];
                var latDiff = Math.abs(lat - city.lat);
                var lngDiff = Math.abs(lng - city.lng);
                
                if (latDiff <= city.range && lngDiff <= city.range) {
                    return city.name;
                }
            }
            
            // If no exact match, create approximate location
            var state = '';
            if (lng < -120) state = 'CA';
            else if (lng < -110) state = 'NV/UT/AZ';
            else if (lng < -100) state = 'CO/NM';
            else if (lng < -90) state = 'TX/OK';
            else if (lng < -80) state = 'FL/GA';
            else state = 'East Coast';
            
            return 'Current Location, ' + state;
        }

        function toggleMap() {
            var mapSection = document.getElementById('map-section');
            var toggleBtn = document.getElementById('map-toggle-btn');
            var sizeBtn = document.getElementById('map-size-btn');
            
            if (state.mapVisible) {
                // Hide map
                mapSection.classList.add('hidden');
                toggleBtn.textContent = 'Show Map';
                sizeBtn.classList.add('hidden');
                state.mapVisible = false;
            } else {
                // Show map
                mapSection.classList.remove('hidden');
                toggleBtn.textContent = 'Hide Map';
                sizeBtn.classList.remove('hidden');
                state.mapVisible = true;
                
                // Initialize map if not already done
                if (!state.map) {
                    initializeMap();
                } else {
                    // Resize map in case container changed
                    setTimeout(function() {
                        state.map.invalidateSize();
                    }, 100);
                }
            }
        }

        function toggleMapSize() {
            var mapSection = document.getElementById('map-section');
            var sizeBtn = document.getElementById('map-size-btn');
            var body = document.body;
            
            if (state.mapFullscreen) {
                // Exit fullscreen
                mapSection.classList.remove('map-fullscreen');
                mapSection.innerHTML = '<div id="map" class="map-container"></div><div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem; text-align: center;">Road routing powered by OpenStreetMap</div>';
                sizeBtn.textContent = 'Expand Map';
                state.mapFullscreen = false;
                body.style.overflow = 'auto';
                
                // Reinitialize map in normal container
                setTimeout(function() {
                    initializeMap();
                    // Re-add routes if they exist
                    if (state.routes.length > 0 && state.destination) {
                        geocodeAddress(state.destination).then(function(destCoords) {
                            addAllRoutesToMap(destCoords);
                            if (state.selectedRoute) {
                                selectRouteOption(state.selectedRoute.id);
                            }
                        }).catch(function() {
                            console.log('Could not re-add routes after map resize');
                        });
                    }
                }, 100);
            } else {
                // Enter fullscreen
                state.mapFullscreen = true;
                body.style.overflow = 'hidden';
                
                mapSection.classList.add('map-fullscreen');
                mapSection.innerHTML = 
                    '<div class="map-fullscreen-content">' +
                        '<div style="background: #2563eb; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">' +
                            '<h2>Navigation Map</h2>' +
                            '<button onclick="toggleMapSize()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.5rem 1rem; border-radius: 4px;">Exit Fullscreen</button>' +
                        '</div>' +
                        '<div id="map" class="map-container"></div>' +
                    '</div>';
                
                sizeBtn.textContent = 'Exit Fullscreen';
                
                // Reinitialize map in fullscreen container
                setTimeout(function() {
                    initializeMap();
                    // Re-add routes if they exist
                    if (state.routes.length > 0 && state.destination) {
                        geocodeAddress(state.destination).then(function(destCoords) {
                            addAllRoutesToMap(destCoords);
                            if (state.selectedRoute) {
                                selectRouteOption(state.selectedRoute.id);
                            }
                        }).catch(function() {
                            console.log('Could not re-add routes after map resize');
                        });
                    }
                }, 100);
            }
        }

        function initializeMap() {
            console.log('Initializing OpenStreetMap with road routing...');
            
            // Create map centered on current location
            state.map = L.map('map').setView([state.currentLocation.lat, state.currentLocation.lng], 10);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(state.map);
            
            // Add current location marker
            var currentLocationIcon = L.divIcon({
                className: 'current-location-marker',
                html: '<div style="background: #2563eb; width: 12px; height: 12px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>',
                iconSize: [18, 18],
                iconAnchor: [9, 9]
            });
            
            state.currentLocationMarker = L.marker([state.currentLocation.lat, state.currentLocation.lng], {
                icon: currentLocationIcon
            }).addTo(state.map);
            
            state.currentLocationMarker.bindPopup('Current Location<br>' + state.currentCity + '<br>Elevation: ' + Math.round(state.currentLocation.elevation) + ' ft');
            
            console.log('Map initialized successfully');
        }

        function updateMapLocation() {
            if (state.map && state.currentLocationMarker) {
                var lat = state.currentLocation.lat;
                var lng = state.currentLocation.lng;
                
                // Update marker position
                state.currentLocationMarker.setLatLng([lat, lng]);
                
                // Update popup content
                state.currentLocationMarker.bindPopup('Current Location<br>' + state.currentCity + '<br>Elevation: ' + Math.round(state.currentLocation.elevation) + ' ft');
                
                // Center map on new location
                state.map.setView([lat, lng], state.map.getZoom());
            }
        }

        function geocodeAddress(address) {
            console.log('Geocoding address:', address);
            
            // First try with common destinations
            var commonDestination = findCommonDestination(address);
            if (commonDestination) {
                console.log('Found common destination:', commonDestination);
                return Promise.resolve(commonDestination);
            }
            
            // Use Nominatim API for geocoding with better error handling
            var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + 
                      encodeURIComponent(address) + 
                      '&limit=3&countrycodes=us&addressdetails=1';
            
            return fetch(url)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Geocoding service unavailable');
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('Geocoding response:', data);
                    
                    if (data && data.length > 0) {
                        var result = data[0];
                        return {
                            lat: parseFloat(result.lat),
                            lng: parseFloat(result.lon),
                            display_name: result.display_name || address
                        };
                    }
                    
                    // If no results, try partial matching
                    var partialMatch = findPartialMatch(address);
                    if (partialMatch) {
                        console.log('Found partial match:', partialMatch);
                        return partialMatch;
                    }
                    
                    throw new Error('No results found for: ' + address);
                })
                .catch(function(error) {
                    console.error('Geocoding error:', error);
                    
                    // Fallback to partial matching
                    var fallback = findPartialMatch(address);
                    if (fallback) {
                        console.log('Using fallback destination:', fallback);
                        return fallback;
                    }
                    
                    throw new Error('Could not find destination: ' + address + '. Try entering a city name, landmark, or full address.');
                });
        }

        function findCommonDestination(address) {
            var lowerAddress = address.toLowerCase().trim();
            
            // Common destinations database
            var destinations = {
                // Major Cities
                'los angeles': { lat: 34.0522, lng: -118.2437, display_name: 'Los Angeles, CA' },
                'la': { lat: 34.0522, lng: -118.2437, display_name: 'Los Angeles, CA' },
                'san francisco': { lat: 37.7749, lng: -122.4194, display_name: 'San Francisco, CA' },
                'sf': { lat: 37.7749, lng: -122.4194, display_name: 'San Francisco, CA' },
                'denver': { lat: 39.7392, lng: -104.9903, display_name: 'Denver, CO' },
                'seattle': { lat: 47.6062, lng: -122.3321, display_name: 'Seattle, WA' },
                'phoenix': { lat: 33.4484, lng: -112.0740, display_name: 'Phoenix, AZ' },
                'chicago': { lat: 41.8781, lng: -87.6298, display_name: 'Chicago, IL' },
                'new york': { lat: 40.7128, lng: -74.0060, display_name: 'New York, NY' },
                'nyc': { lat: 40.7128, lng: -74.0060, display_name: 'New York, NY' },
                'miami': { lat: 25.7617, lng: -80.1918, display_name: 'Miami, FL' },
                'las vegas': { lat: 36.1699, lng: -115.1398, display_name: 'Las Vegas, NV' },
                'vegas': { lat: 36.1699, lng: -115.1398, display_name: 'Las Vegas, NV' },
                'salt lake city': { lat: 40.7608, lng: -111.8910, display_name: 'Salt Lake City, UT' },
                'portland': { lat: 45.5152, lng: -122.6784, display_name: 'Portland, OR' },
                'atlanta': { lat: 33.7490, lng: -84.3880, display_name: 'Atlanta, GA' },
                'dallas': { lat: 32.7767, lng: -96.7970, display_name: 'Dallas, TX' },
                'houston': { lat: 29.7604, lng: -95.3698, display_name: 'Houston, TX' },
                'boston': { lat: 42.3601, lng: -71.0589, display_name: 'Boston, MA' },
                'washington dc': { lat: 38.9072, lng: -77.0369, display_name: 'Washington, DC' },
                'dc': { lat: 38.9072, lng: -77.0369, display_name: 'Washington, DC' },
                
                // California Cities
                'san diego': { lat: 32.7157, lng: -117.1611, display_name: 'San Diego, CA' },
                'sacramento': { lat: 38.5816, lng: -121.4944, display_name: 'Sacramento, CA' },
                'fresno': { lat: 36.7378, lng: -119.7871, display_name: 'Fresno, CA' },
                'oakland': { lat: 37.8044, lng: -122.2711, display_name: 'Oakland, CA' },
                'san jose': { lat: 37.3382, lng: -121.8863, display_name: 'San Jose, CA' },
                'long beach': { lat: 33.7701, lng: -118.1937, display_name: 'Long Beach, CA' },
                'santa barbara': { lat: 34.4208, lng: -119.6982, display_name: 'Santa Barbara, CA' },
                'monterey': { lat: 36.6002, lng: -121.8947, display_name: 'Monterey, CA' },
                'bakersfield': { lat: 35.3733, lng: -119.0187, display_name: 'Bakersfield, CA' },
                
                // Mountain/High Elevation Cities
                'flagstaff': { lat: 35.1983, lng: -111.6513, display_name: 'Flagstaff, AZ' },
                'boulder': { lat: 40.0150, lng: -105.2705, display_name: 'Boulder, CO' },
                'aspen': { lat: 39.1911, lng: -106.8175, display_name: 'Aspen, CO' },
                'park city': { lat: 40.6461, lng: -111.4980, display_name: 'Park City, UT' },
                'tahoe': { lat: 39.0968, lng: -120.0324, display_name: 'Lake Tahoe, CA' },
                'lake tahoe': { lat: 39.0968, lng: -120.0324, display_name: 'Lake Tahoe, CA' },
                
                // Landmarks and Popular Destinations
                'disneyland': { lat: 33.8121, lng: -117.9190, display_name: 'Disneyland, Anaheim, CA' },
                'disney world': { lat: 28.3852, lng: -81.5639, display_name: 'Disney World, Orlando, FL' },
                'grand canyon': { lat: 36.1069, lng: -112.1129, display_name: 'Grand Canyon National Park, AZ' },
                'yellowstone': { lat: 44.4280, lng: -110.5885, display_name: 'Yellowstone National Park, WY' },
                'yosemite': { lat: 37.8651, lng: -119.5383, display_name: 'Yosemite National Park, CA' },
                'death valley': { lat: 36.5323, lng: -116.9325, display_name: 'Death Valley National Park, CA' },
                'joshua tree': { lat: 33.8734, lng: -115.9010, display_name: 'Joshua Tree National Park, CA' },
                
                // Airports
                'lax': { lat: 33.9425, lng: -118.4081, display_name: 'Los Angeles International Airport, CA' },
                'sfo': { lat: 37.6213, lng: -122.3790, display_name: 'San Francisco International Airport, CA' },
                'jfk': { lat: 40.6413, lng: -73.7781, display_name: 'JFK Airport, New York, NY' },
                'dfw': { lat: 32.8998, lng: -97.0403, display_name: 'Dallas/Fort Worth Airport, TX' }
            };
            
            // Direct match
            if (destinations[lowerAddress]) {
                return destinations[lowerAddress];
            }
            
            // Check for partial matches (e.g., "san fran" matches "san francisco")
            for (var key in destinations) {
                if (key.includes(lowerAddress) || lowerAddress.includes(key)) {
                    return destinations[key];
                }
            }
            
            return null;
        }

        function findPartialMatch(address) {
            var lowerAddress = address.toLowerCase().trim();
            
            // Try to extract city/state patterns
            var cityStateMatch = lowerAddress.match(/([a-z\s]+),?\s*([a-z]{2})/);
            if (cityStateMatch) {
                var city = cityStateMatch[1].trim();
                var state = cityStateMatch[2].trim().toUpperCase();
                
                // Try common city/state combinations
                var stateCoords = getStateCenter(state);
                if (stateCoords) {
                    return {
                        lat: stateCoords.lat + (Math.random() - 0.5) * 0.5,
                        lng: stateCoords.lng + (Math.random() - 0.5) * 0.5,
                        display_name: city.charAt(0).toUpperCase() + city.slice(1) + ', ' + state
                    };
                }
            }
            
            // Try state-only lookup
            var states = {
                'california': { lat: 36.7783, lng: -119.4179 },
                'ca': { lat: 36.7783, lng: -119.4179 },
                'texas': { lat: 31.9686, lng: -99.9018 },
                'tx': { lat: 31.9686, lng: -99.9018 },
                'florida': { lat: 27.7663, lng: -82.6404 },
                'fl': { lat: 27.7663, lng: -82.6404 },
                'new york': { lat: 42.1657, lng: -74.9481 },
                'ny': { lat: 42.1657, lng: -74.9481 },
                'colorado': { lat: 39.0598, lng: -105.3111 },
                'co': { lat: 39.0598, lng: -105.3111 }
            };
            
            for (var state in states) {
                if (lowerAddress.includes(state)) {
                    return {
                        lat: states[state].lat,
                        lng: states[state].lng,
                        display_name: address + ' (approximate location)'
                    };
                }
            }
            
            return null;
        }

        function getStateCenter(stateCode) {
            var states = {
                'CA': { lat: 36.7783, lng: -119.4179 },
                'TX': { lat: 31.9686, lng: -99.9018 },
                'FL': { lat: 27.7663, lng: -82.6404 },
                'NY': { lat: 42.1657, lng: -74.9481 },
                'CO': { lat: 39.0598, lng: -105.3111 },
                'AZ': { lat: 33.7298, lng: -111.4312 },
                'NV': { lat: 38.3135, lng: -117.0554 },
                'UT': { lat: 40.1500, lng: -111.8947 },
                'WA': { lat: 47.0379, lng: -121.0187 },
                'OR': { lat: 44.5720, lng: -122.0709 }
            };
            
            return states[stateCode] || null;
        }

        function getCurrentLocation() {
            initGPS();
        }

        function updateDisplay() {
            // Update GPS status
            var gpsStatusEl = document.getElementById('gps-status');
            var statusDotEl = document.getElementById('status-dot');
            
            switch (state.gpsStatus) {
                case 'connected':
                    gpsStatusEl.textContent = 'GPS: Active';
                    statusDotEl.className = 'status-indicator status-connected';
                    break;
                case 'connecting':
                    gpsStatusEl.textContent = 'GPS: Connecting...';
                    statusDotEl.className = 'status-indicator status-connecting';
                    break;
                case 'error':
                    gpsStatusEl.textContent = 'GPS: Error';
                    statusDotEl.className = 'status-indicator status-error';
                    break;
            }

            // Update elevation status
            updateElevationDisplay();
        }

        function updateElevationDisplay() {
            var elevation = state.currentLocation.elevation;
            var threshold = state.elevationThreshold;
            
            var statusCard = document.getElementById('elevation-status');
            var elevationValue = document.getElementById('elevation-value');
            var thresholdValue = document.getElementById('threshold-value');
            var warningIcon = document.getElementById('warning-icon');
            var currentCity = document.getElementById('current-city');
            
            elevationValue.textContent = Math.round(elevation) + ' ft';
            thresholdValue.textContent = threshold;
            currentCity.textContent = state.currentCity;
            
            // Remove all elevation classes
            statusCard.className = 'status-card';
            
            if (elevation > threshold) {
                statusCard.classList.add('elevation-danger');
                warningIcon.classList.remove('hidden');
            } else if (elevation > threshold * 0.8) {
                statusCard.classList.add('elevation-warning');
                warningIcon.classList.add('hidden');
            } else {
                statusCard.classList.add('elevation-safe');
                warningIcon.classList.add('hidden');
            }
        }

        function calculateRoutes() {
            var destination = document.getElementById('destination').value.trim();
            if (!destination) {
                alert('Please enter a destination!');
                return;
            }
            
            state.destination = destination;
            console.log('Calculating routes to:', destination);
            
            // Show loading state
            var routesSection = document.getElementById('routes-section');
            var container = document.getElementById('routes-container');
            
            routesSection.classList.remove('hidden');
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">üîç Finding destination and calculating elevation-aware routes...</div>';
            
            // Geocode the destination first
            geocodeAddress(destination)
                .then(function(destCoords) {
                    console.log('Destination found:', destCoords);
                    
                    // Update destination display name if we got a better one
                    if (destCoords.display_name && destCoords.display_name !== destination) {
                        state.destination = destCoords.display_name;
                        document.getElementById('destination').value = destCoords.display_name;
                    }
                    
                    // Show success message briefly
                    container.innerHTML = '<div style="text-align: center; padding: 1rem; color: #16a34a;">‚úÖ Destination found: ' + destCoords.display_name + '<br>üó∫Ô∏è Generating elevation-aware routes...</div>';
                    
                    // Generate route options with real road routing
                    setTimeout(function() {
                        state.routes = generateRouteOptions(state.currentLocation, destCoords);
                        
                        // Show the routes
                        displayRoutes();
                        // Also display route elevations
                        displayRouteElevations(state.routes);
                        
                        // Add routing to map if visible
                        if (state.mapVisible && state.map) {
                            addAllRoutesToMap(destCoords);
                        }
                        
                        console.log('Routes calculated successfully');
                    }, 800);
                })
                .catch(function(error) {
                    console.error('Geocoding error:', error);
                    container.innerHTML = 
                        '<div style="text-align: center; padding: 2rem; color: #dc2626;">' +
                            '<div style="font-size: 2rem; margin-bottom: 1rem;">‚ùå</div>' +
                            '<div style="font-weight: bold; margin-bottom: 1rem;">Destination Not Found</div>' +
                            '<div style="margin-bottom: 1rem;">' + error.message + '</div>' +
                            '<div style="font-size: 0.9rem; color: #6b7280;">' +
                                '<strong>Try these examples:</strong><br>' +
                                '‚Ä¢ City names: "San Francisco", "Denver", "Seattle"<br>' +
                                '‚Ä¢ Landmarks: "Disneyland", "Grand Canyon", "Yosemite"<br>' +
                                '‚Ä¢ Airports: "LAX", "SFO", "JFK"<br>' +
                                '‚Ä¢ Full addresses: "123 Main St, Los Angeles, CA"' +
                            '</div>' +
                        '</div>';
                });
        }

        // Display route elevations for each route (async, example)
        async function displayRouteElevations(routes) {
            const routesContainer = document.getElementById('routes-container');
            routesContainer.innerHTML = '';

            for (let i = 0; i < routes.length; i++) {
                const route = routes[i];
                // Use route.profile as elevation samples if available
                const steps = route.profile || [];

                const elevationBars = [];
                for (const elevation of steps) {
                    let className = 'elevation-bar';
                    if (elevation > state.elevationThreshold) {
                        className += ' danger';
                    }
                    elevationBars.push(`<div class="${className}" style="height: ${Math.min(60, elevation / 100)}px;"></div>`);
                }

                const routeCard = document.createElement('div');
                routeCard.className = 'route-card';
                routeCard.innerHTML = `
                    <div class="route-header">
                        <strong>Route ${i + 1}</strong>
                    </div>
                    <div class="elevation-profile">
                        ${elevationBars.join('')}
                    </div>
                `;
                routesContainer.appendChild(routeCard);
            }

            document.getElementById('routes-section').classList.remove('hidden');
        }

        function generateRouteOptions(origin, destination) {
            // Calculate real distance and bearing between actual locations
            var distance = calculateDistance(origin.lat, origin.lng, destination);
            var bearing = calculateBearing(origin.lat, origin.lng, destination.lat, destination.lng);
            var elevationData = calculateDynamicElevationProfile(origin, destination);
            
            console.log('Generating dynamic routes from', origin, 'to', destination);
            console.log('Distance:', distance, 'miles, Bearing:', bearing, 'degrees');
            
            return [
                {
                    id: 1,
                    name: 'Lowest Elevation Route',
                    distance: Math.round(distance * 1.35) + ' miles', // Longer due to valley following
                    duration: calculateTravelTime(distance * 1.35, 35),
                    maxElevation: elevationData.low.maxElevation,
                    elevationGain: elevationData.low.elevationGain,
                    recommended: true,
                    profile: elevationData.low.profile,
                    description: 'Follows valleys and lower terrain roads. Safest for respiratory conditions.',
                    routeType: 'low_elevation'
                },
                {
                    id: 2,
                    name: 'Fastest Route',
                    distance: Math.round(distance * 1.05) + ' miles', // Most direct
                    duration: calculateTravelTime(distance * 1.05, 65),
                    maxElevation: elevationData.fast.maxElevation,
                    elevationGain: elevationData.fast.elevationGain,
                    recommended: false,
                    profile: elevationData.fast.profile,
                    description: 'Direct highway route. Fastest but may include higher elevations.',
                    routeType: 'fastest'
                },
                {
                    id: 3,
                    name: 'Balanced Route',
                    distance: Math.round(distance * 1.20) + ' miles', // Moderate detour
                    duration: calculateTravelTime(distance * 1.20, 50),
                    maxElevation: elevationData.balanced.maxElevation,
                    elevationGain: elevationData.balanced.elevationGain,
                    recommended: false,
                    profile: elevationData.balanced.profile,
                    description: 'Good compromise between time and elevation exposure.',
                    routeType: 'balanced'
                }
            ];
        }

        function calculateBearing(lat1, lng1, lat2, lng2) {
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var lat1Rad = lat1 * Math.PI / 180;
            var lat2Rad = lat2 * Math.PI / 180;
            
            var y = Math.sin(dLng) * Math.cos(lat2Rad);
            var x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
            
            var bearing = Math.atan2(y, x) * 180 / Math.PI;
            return (bearing + 360) % 360;
        }

        function calculateDynamicElevationProfile(origin, destination) {
            var startElev = origin.elevation;
            var destElev = estimateDynamicElevation(destination.lat, destination.lng);
            var distance = calculateDistance(origin.lat, origin.lng, destination);
            
            console.log('Dynamic elevation calculation:', startElev, 'ft to', destElev, 'ft over', distance, 'miles');
            
            // Calculate terrain complexity based on actual geographic factors
            var terrainFactor = calculateTerrainComplexity(origin, destination);
            
            return {
                low: {
                    maxElevation: Math.round(Math.max(startElev, destElev) + (terrainFactor.low * distance * 50)),
                    elevationGain: Math.round(Math.abs(destElev - startElev) + (terrainFactor.low * distance * 30)),
                    profile: generateDynamicElevationProfile(startElev, destElev, 'low', 20, distance, terrainFactor)
                },
                fast: {
                    maxElevation: Math.round(Math.max(startElev, destElev) + (terrainFactor.fast * distance * 120)),
                    elevationGain: Math.round(Math.abs(destElev - startElev) + (terrainFactor.fast * distance * 80)),
                    profile: generateDynamicElevationProfile(startElev, destElev, 'fast', 20, distance, terrainFactor)
                },
                balanced: {
                    maxElevation: Math.round(Math.max(startElev, destElev) + (terrainFactor.balanced * distance * 80)),
                    elevationGain: Math.round(Math.abs(destElev - startElev) + (terrainFactor.balanced * distance * 50)),
                    profile: generateDynamicElevationProfile(startElev, destElev, 'balanced', 20, distance, terrainFactor)
                }
            };
        }

        function calculateTerrainComplexity(origin, destination) {
            // Analyze terrain based on actual geographic location
            var latDiff = Math.abs(destination.lat - origin.lat);
            var lngDiff = Math.abs(destination.lng - origin.lng);
            
            // Mountain ranges and terrain analysis
            var isMountainous = false;
            var isCoastal = false;
            var isPlains = false;
            
            // West Coast mountains (Cascades, Sierra Nevada, Coast Ranges)
            if ((origin.lng < -115 || destination.lng < -115) && 
                (Math.abs(origin.lat - destination.lat) > 2 || Math.abs(origin.lng - destination.lng) > 2)) {
                isMountainous = true;
            }
            
            // Rocky Mountains
            if ((origin.lng > -115 && origin.lng < -100) || (destination.lng > -115 && destination.lng < -100)) {
                if (origin.lat > 35 || destination.lat > 35) {
                    isMountainous = true;
                }
            }
            
            // Coastal routes
            if ((origin.lng < -115 && Math.abs(origin.lat - destination.lat) < 3) ||
                (destination.lng < -115 && Math.abs(origin.lat - destination.lat) < 3)) {
                isCoastal = true;
            }
            
            // Plains (minimal elevation change)
            if (origin.lng > -100 && destination.lng > -100 && 
                origin.lat > 30 && origin.lat < 45 && destination.lat > 30 && destination.lat < 45) {
                isPlains = true;
            }
            
            console.log('Terrain analysis:', { isMountainous, isCoastal, isPlains });
            
            if (isMountainous) {
                return { low: 0.8, fast: 2.5, balanced: 1.5 };
            } else if (isCoastal) {
                return { low: 0.3, fast: 0.8, balanced: 0.5 };
            } else if (isPlains) {
                return { low: 0.2, fast: 0.4, balanced: 0.3 };
            } else {
                return { low: 0.5, fast: 1.2, balanced: 0.8 }; // Default hilly terrain
            }
        }

        function generateDynamicElevationProfile(startElev, endElev, routeType, points, distance, terrainFactor) {
            var profile = [];
            var factor = terrainFactor[routeType];
            
            for (var i = 0; i <= points; i++) {
                var progress = i / points;
                var baseElev = startElev + (endElev - startElev) * progress;
                var distanceProgress = distance * progress;
                
                var elevationVariation = 0;
                
                if (routeType === 'low') {
                    // Valley route - follows low areas, avoids peaks
                    elevationVariation = Math.sin(progress * Math.PI * 2) * (100 * factor) + 
                                       Math.cos(progress * Math.PI * 3) * (50 * factor) +
                                       (Math.random() - 0.5) * (80 * factor);
                    // Keep it lower than base elevation
                    elevationVariation = Math.min(elevationVariation, baseElev * 0.1);
                    
                } else if (routeType === 'fast') {
                    // Highway route - goes over terrain obstacles directly
                    elevationVariation = Math.sin(progress * Math.PI) * (300 * factor) + 
                                       Math.sin(progress * Math.PI * 1.5) * (200 * factor) +
                                       (Math.random() - 0.5) * (150 * factor);
                    
                } else {
                    // Balanced route - moderate elevation changes
                    elevationVariation = Math.sin(progress * Math.PI * 2.5) * (180 * factor) + 
                                       Math.cos(progress * Math.PI * 2) * (120 * factor) +
                                       (Math.random() - 0.5) * (100 * factor);
                }
                
                var finalElevation = Math.max(0, baseElev + elevationVariation);
                profile.push(Math.round(finalElevation));
            }
            
            return profile;
        }

        function estimateDynamicElevation(lat, lng) {
            // More sophisticated elevation estimation based on actual geography
            
            // Sea level locations
            if (lng < -115 && lat > 32 && lat < 42) {
                // California coast
                return Math.round(50 + Math.random() * 200);
            }
            
            if (lng > -85 && lat > 25 && lat < 35) {
                // Florida
                return Math.round(10 + Math.random() * 100);
            }
            
            if (lng > -75 && lat > 35) {
                // East Coast
                return Math.round(20 + Math.random() * 300);
            }
            
            // Mountain regions
            if (lng > -115 && lng < -100 && lat > 35 && lat < 50) {
                // Rocky Mountains
                return Math.round(3000 + Math.random() * 4000);
            }
            
            if (lng < -115 && lat > 35 && lat < 42) {
                // Sierra Nevada, Cascades
                return Math.round(1000 + Math.random() * 3000);
            }
            
            if (lng > -115 && lng < -110 && lat > 30 && lat < 40) {
                // Arizona/Utah high desert
                return Math.round(2000 + Math.random() * 2000);
            }
            
            // Plains
            if (lng > -100 && lng < -90 && lat > 30 && lat < 45) {
                // Great Plains
                return Math.round(800 + Math.random() * 1200);
            }
            
            // Default elevation for other areas
            return Math.round(500 + Math.random() * 1000);
        }

        function calculateDistance(lat1, lng1, coords2) {
            // Haversine formula for distance calculation
            var R = 3959; // Earth's radius in miles
            var dLat = (coords2.lat - lat1) * Math.PI / 180;
            var dLng = (coords2.lng - lng1) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(coords2.lat * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculateElevationProfile(origin, destination) {
            var startElev = origin.elevation;
            var destElev = estimateElevation(destination.lat, destination.lng);
            
            return {
                low: {
                    maxElevation: Math.round(Math.max(startElev, destElev) + 300),
                    elevationGain: Math.round(Math.abs(destElev - startElev) + 200),
                    profile: generateElevationProfile(startElev, destElev, 'low', 15)
                },
                fast: {
                    maxElevation: Math.round(Math.max(startElev, destElev) + 1500),
                    elevationGain: Math.round(Math.abs(destElev - startElev) + 1200),
                    profile: generateElevationProfile(startElev, destElev, 'fast', 15)
                },
                balanced: {
                    maxElevation: Math.round(Math.max(startElev, destElev) + 800),
                    elevationGain: Math.round(Math.abs(destElev - startElev) + 600),
                    profile: generateElevationProfile(startElev, destElev, 'balanced', 15)
                }
            };
        }

        function generateElevationProfile(startElev, endElev, routeType, points) {
            var profile = [];
            
            for (var i = 0; i <= points; i++) {
                var progress = i / points;
                var baseElev = startElev + (endElev - startElev) * progress;
                
                if (routeType === 'low') {
                    // Valley route - stays low with minimal peaks
                    var variation = Math.sin(progress * Math.PI * 2) * 150 + Math.random() * 100;
                    profile.push(Math.max(startElev - 50, baseElev + variation));
                } else if (routeType === 'fast') {
                    // Highway route - may go over hills/mountains
                    var peak = Math.sin(progress * Math.PI) * 1200;
                    profile.push(baseElev + peak + Math.random() * 200);
                } else {
                    // Balanced route - moderate hills
                    var hills = Math.sin(progress * Math.PI * 3) * 400 + Math.random() * 150;
                    profile.push(baseElev + hills);
                }
            }
            
            return profile.map(function(elev) { return Math.round(Math.max(0, elev)); });
        }

        function estimateElevation(lat, lng) {
            // Estimate elevation based on geographic patterns
            if (lng < -115) {
                return Math.round(50 + Math.random() * 400); // West Coast
            } else if (lng < -105) {
                return Math.round(3000 + Math.random() * 2000); // Mountain West
            } else if (lng < -95) {
                return Math.round(1000 + Math.random() * 1000); // Plains
            } else {
                return Math.round(100 + Math.random() * 600); // East Coast
            }
        }

        function calculateTravelTime(distance, avgSpeed) {
            var hours = distance / avgSpeed;
            var h = Math.floor(hours);
            var m = Math.round((hours - h) * 60);
            
            if (h === 0) {
                return m + 'm';
            }
            return h + 'h ' + (m > 0 ? m + 'm' : '');
        }

        function getElevationColor(elevation) {
            if (elevation <= 2000) {
                return '#16a34a'; // Green for 2,000ft or less
            } else if (elevation <= 4000) {
                return '#f59e0b'; // Yellow for 2,001-4,000ft
            } else if (elevation <= 6000) {
                return '#f97316'; // Orange for 4,001-6,000ft
            } else {
                return '#dc2626'; // Red for above 6,000ft
            }
        }

        function addAllRoutesToMap(destination) {
            if (!state.map) return;
            
            console.log('Adding all route options to map');
            
            // Clear existing routes
            clearAllRoutesFromMap();
            
            // Create route lines for each option
            state.routeLines = {};
            
            // Add start and end markers
            addRouteMarkers(destination);
            
            // Generate and add each route option
            for (var i = 0; i < state.routes.length; i++) {
                var route = state.routes[i];
                addRouteToMap(route, destination, i === 0); // Show first route by default
            }
            
            // Fit map to show all routes
            if (state.routeLines[1]) {
                state.map.fitBounds(state.routeLines[1].getBounds(), { padding: [20, 20] });
            }
        }

        function addRouteMarkers(destination) {
            // Add start marker
            var startIcon = L.divIcon({
                className: 'start-marker',
                html: '<div style="background: #16a34a; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">START</div>',
                iconSize: [50, 24],
                iconAnchor: [25, 12]
            });
            
            state.startMarker = L.marker([state.currentLocation.lat, state.currentLocation.lng], { 
                icon: startIcon 
            }).addTo(state.map);
            
            state.startMarker.bindPopup('Start: ' + state.currentCity + '<br>Elevation: ' + Math.round(state.currentLocation.elevation) + ' ft');
            
            // Add end marker
            var endIcon = L.divIcon({
                className: 'end-marker',
                html: '<div style="background: #dc2626; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">END</div>',
                iconSize: [40, 24],
                iconAnchor: [20, 12]
            });
            
            state.endMarker = L.marker([destination.lat, destination.lng], { 
                icon: endIcon 
            }).addTo(state.map);
            
            state.endMarker.bindPopup('Destination: ' + state.destination);
        }

        function addRouteToMap(route, destination, isVisible) {
            var routeCoords = generateRouteCoordinates(route, destination);
            
            // Create route segments with elevation-based colors
            var routeSegments = [];
            var routeGroup = L.layerGroup();
            
            for (var i = 0; i < routeCoords.length - 1; i++) {
                var segmentStart = routeCoords[i];
                var segmentEnd = routeCoords[i + 1];
                
                // Get elevation for this segment (use profile data)
                var profileIndex = Math.floor((i / (routeCoords.length - 1)) * (route.profile.length - 1));
                var elevation = route.profile[profileIndex] || route.profile[0];
                
                // Get color based on elevation
                var segmentColor = getElevationColor(elevation);
                
                // Create segment line
                var segment = L.polyline([segmentStart, segmentEnd], {
                    color: segmentColor,
                    weight: isVisible ? 6 : 4,
                    opacity: isVisible ? 0.9 : 0.3,
                    dashArray: isVisible ? null : '10, 10'
                });
                
                // Add click handler to select this route
                segment.on('click', function() {
                    selectRouteOption(route.id);
                });
                
                routeGroup.addLayer(segment);
                routeSegments.push(segment);
            }
            
            // Add the route group to map
            routeGroup.addTo(state.map);
            
            // Add popup with route info to the group
            var popupContent = '<strong>' + route.name + '</strong><br>' +
                'Distance: ' + route.distance + '<br>' +
                'Time: ' + route.duration + '<br>' +
                'Max Elevation: ' + route.maxElevation + ' ft<br>' +
                '<div style="margin-top: 8px; font-size: 0.8rem;">' +
                '<div><span style="color: #16a34a;">‚óè</span> ‚â§2,000ft</div>' +
                '<div><span style="color: #f59e0b;">‚óè</span> 2,001-4,000ft</div>' +
                '<div><span style="color: #f97316;">‚óè</span> 4,001-6,000ft</div>' +
                '<div><span style="color: #dc2626;">‚óè</span> >6,000ft</div>' +
                '</div>';
            
            if (route.maxElevation > state.elevationThreshold) {
                popupContent += '<br><span style="color: #dc2626; font-weight: bold;">‚ö†Ô∏è Exceeds Your Safe Limit</span>';
            }
            
            // Add popup to first segment
            if (routeSegments.length > 0) {
                routeSegments[0].bindPopup(popupContent);
            }
            
            // Store route reference
            state.routeLines[route.id] = {
                group: routeGroup,
                segments: routeSegments,
                coords: routeCoords
            };
            
            // Add elevation markers for visible route
            if (isVisible) {
                addElevationMarkers(route, routeCoords);
            }
        }

        function addElevationMarkers(route, routeCoords) {
            // Clear existing elevation markers
            if (state.elevationMarkers) {
                for (var i = 0; i < state.elevationMarkers.length; i++) {
                    state.map.removeLayer(state.elevationMarkers[i]);
                }
            }
            state.elevationMarkers = [];
            
            // Add elevation markers along the route
            var markerInterval = Math.max(1, Math.floor(route.profile.length / 6)); // Show 6 markers max
            
            for (var i = 0; i < route.profile.length; i += markerInterval) {
                var coordIndex = Math.floor((i / (route.profile.length - 1)) * (routeCoords.length - 1));
                var elevation = route.profile[i];
                var elevationColor = getElevationColor(elevation);
                var isHighElevation = elevation > state.elevationThreshold;
                
                var elevationIcon = L.divIcon({
                    className: 'elevation-marker',
                    html: '<div style="background: ' + elevationColor + '; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">' + elevation + 'ft</div>',
                    iconSize: [50, 20],
                    iconAnchor: [25, 10]
                });
                
                var elevationMarker = L.marker(routeCoords[coordIndex], { icon: elevationIcon }).addTo(state.map);
                
                var markerPopupContent = 'Elevation: ' + elevation + ' ft<br>' +
                    'Zone: ' + getElevationZoneName(elevation);
                
                if (isHighElevation) {
                    markerPopupContent += '<br><strong style="color: #dc2626;">‚ö†Ô∏è Above Your Safe Limit (' + state.elevationThreshold + ' ft)</strong>';
                }
                
                elevationMarker.bindPopup(markerPopupContent);
                state.elevationMarkers.push(elevationMarker);
            }
        }

        function getElevationZoneName(elevation) {
            if (elevation <= 2000) {
                return 'Low Elevation (Safe)';
            } else if (elevation <= 4000) {
                return 'Moderate Elevation';
            } else if (elevation <= 6000) {
                return 'High Elevation';
            } else {
                return 'Very High Elevation';
            }
        }

        function generateRouteCoordinates(route, destination) {
            var coords = [];
            var startLat = state.currentLocation.lat;
            var startLng = state.currentLocation.lng;
            var endLat = destination.lat;
            var endLng = destination.lng;
            
            // Calculate actual bearing and distance for realistic routing
            var bearing = calculateBearing(startLat, startLng, endLat, endLng);
            var distance = calculateDistance(startLat, startLng, destination);
            
            var steps = 30; // More segments for better elevation color transition
            
            console.log('Generating route coordinates:', route.routeType, 'bearing:', bearing, 'distance:', distance);
            
            for (var i = 0; i <= steps; i++) {
                var progress = i / steps;
                var lat, lng;
                
                // Base interpolation between start and end points
                var baseLat = startLat + (endLat - startLat) * progress;
                var baseLng = startLng + (endLng - startLng) * progress;
                
                if (route.routeType === 'low_elevation') {
                    // Valley route - follows terrain contours, more winding to avoid elevation
                    var valleyDeviation = 0.8; // Larger deviation to follow valleys
                    var windingFactor = 4; // More winding
                    
                    // Create realistic valley-following pattern
                    lat = baseLat + (Math.sin(progress * Math.PI * windingFactor) * valleyDeviation * distance * 0.08) + 
                          (Math.cos(progress * Math.PI * 2) * valleyDeviation * distance * 0.05);
                    lng = baseLng + (Math.cos(progress * Math.PI * windingFactor) * valleyDeviation * distance * 0.12) + 
                          (Math.sin(progress * Math.PI * 3) * valleyDeviation * distance * 0.06);
                    
                } else if (route.routeType === 'fastest') {
                    // Highway route - most direct path with minimal deviation
                    var highwayDeviation = 0.15; // Minimal deviation for highway efficiency
                    
                    // Slight curves for realistic highway routing
                    lat = baseLat + (Math.sin(progress * Math.PI) * highwayDeviation * distance * 0.02);
                    lng = baseLng + (Math.cos(progress * Math.PI * 0.8) * highwayDeviation * distance * 0.025);
                    
                } else {
                    // Balanced route - moderate scenic routing
                    var scenicDeviation = 0.5;
                    var scenicWinding = 2.5;
                    
                    // Create scenic route pattern
                    lat = baseLat + (Math.sin(progress * Math.PI * scenicWinding) * scenicDeviation * distance * 0.06);
                    lng = baseLng + (Math.cos(progress * Math.PI * scenicWinding) * scenicDeviation * distance * 0.07);
                }
                
                coords.push([lat, lng]);
            }
            
            return coords;
        }

        function selectRouteOption(routeId) {
            console.log('Selecting route option:', routeId);
            
            // Find the route
            var selectedRoute = null;
            for (var i = 0; i < state.routes.length; i++) {
                if (state.routes[i].id === routeId) {
                    selectedRoute = state.routes[i];
                    break;
                }
            }
            
            if (!selectedRoute) return;
            
            // Update visual appearance of all routes
            for (var id in state.routeLines) {
                var routeData = state.routeLines[id];
                var route = state.routes.find(function(r) { return r.id == id; });
                
                if (parseInt(id) === routeId) {
                    // Highlight selected route
                    for (var j = 0; j < routeData.segments.length; j++) {
                        routeData.segments[j].setStyle({
                            opacity: 0.9,
                            weight: 6,
                            dashArray: null
                        });
                    }
                    
                    // Add elevation markers for selected route
                    addElevationMarkers(selectedRoute, routeData.coords);
                } else {
                    // Dim non-selected routes
                    for (var j = 0; j < routeData.segments.length; j++) {
                        routeData.segments[j].setStyle({
                            opacity: 0.3,
                            weight: 4,
                            dashArray: '10, 10'
                        });
                    }
                }
            }
            
            // Update route card selection visual
            updateRouteCardSelection(routeId);
            
            // Store selected route
            state.selectedRoute = selectedRoute;
        }

        function updateRouteCardSelection(selectedId) {
            var routeCards = document.querySelectorAll('.route-card');
            for (var i = 0; i < routeCards.length; i++) {
                var card = routeCards[i];
                var routeId = i + 1; // Route IDs start from 1
                
                if (routeId === selectedId) {
                    card.style.border = '3px solid #2563eb';
                    card.style.backgroundColor = '#eff6ff';
                    card.style.transform = 'scale(1.02)';
                    card.style.boxShadow = '0 4px 12px rgba(37, 99, 235, 0.3)';
                } else {
                    card.style.border = card.classList.contains('route-recommended') ? '2px solid #10b981' : '2px solid #e5e7eb';
                    card.style.backgroundColor = card.classList.contains('route-recommended') ? '#f0fdf4' : 'white';
                    card.style.transform = 'scale(1)';
                    card.style.boxShadow = 'none';
                }
            }
        }

        function clearAllRoutesFromMap() {
            // Clear existing route lines
            if (state.routeLines) {
                for (var id in state.routeLines) {
                    state.map.removeLayer(state.routeLines[id].group);
                }
                state.routeLines = {};
            }
            
            // Clear elevation markers
            if (state.elevationMarkers) {
                for (var i = 0; i < state.elevationMarkers.length; i++) {
                    state.map.removeLayer(state.elevationMarkers[i]);
                }
                state.elevationMarkers = [];
            }
            
            // Clear start/end markers
            if (state.startMarker) {
                state.map.removeLayer(state.startMarker);
                state.startMarker = null;
            }
            if (state.endMarker) {
                state.map.removeLayer(state.endMarker);
                state.endMarker = null;
            }
        }

        function displayRoutes() {
            var container = document.getElementById('routes-container');
            var section = document.getElementById('routes-section');
            
            container.innerHTML = '';
            
            for (var i = 0; i < state.routes.length; i++) {
                var route = state.routes[i];
                var routeEl = document.createElement('div');
                routeEl.className = 'route-card' + (route.recommended ? ' route-recommended' : '');
                
                // Add click handler to select route on map
                routeEl.style.cursor = 'pointer';
                routeEl.onclick = function(routeData) {
                    return function() {
                        selectRouteOption(routeData.id);
                    };
                }(route);
                
                var profileHTML = '';
                for (var j = 0; j < route.profile.length; j++) {
                    var elevation = route.profile[j];
                    var maxElev = Math.max.apply(Math, route.profile);
                    var height = (elevation / maxElev) * 100;
                    var dangerClass = elevation > state.elevationThreshold ? ' danger' : '';
                    profileHTML += '<div class="elevation-bar' + dangerClass + '" style="height: ' + height + '%" title="' + elevation + ' ft"></div>';
                }
                
                var elevationStyle = route.maxElevation > state.elevationThreshold ? 'color: #dc2626; font-weight: bold;' : '';
                var recommendedBadge = route.recommended ? '<span class="badge">RECOMMENDED</span>' : '';
                
                routeEl.innerHTML = 
                    '<div class="route-header">' +
                        '<div>' +
                            '<h4 style="margin-bottom: 0.25rem;">' + route.name + '</h4>' +
                            recommendedBadge +
                        '</div>' +
                        '<div style="display: flex; gap: 0.5rem;">' +
                            '<button onclick="event.stopPropagation(); selectRouteOption(' + route.id + ')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #059669;">Select</button>' +
                            '<button onclick="event.stopPropagation(); startNavigation(' + route.id + ')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">Start</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="route-details">' +
                        '<div>Distance: ' + route.distance + '</div>' +
                        '<div>Time: ' + route.duration + '</div>' +
                        '<div style="' + elevationStyle + '">Max: ' + route.maxElevation + ' ft</div>' +
                        '<div>Gain: ' + route.elevationGain + ' ft</div>' +
                        '<div style="grid-column: 1 / -1; font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">' + route.description + '</div>' +
                    '</div>' +
                    '<div style="margin-top: 0.5rem;">' +
                        '<div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.25rem;">Elevation Profile</div>' +
                        '<div class="elevation-profile">' + profileHTML + '</div>' +
                    '</div>';
                
                container.appendChild(routeEl);
            }
            
            section.classList.remove('hidden');
        }

        function startNavigation(routeId) {
            var route = null;
            for (var i = 0; i < state.routes.length; i++) {
                if (state.routes[i].id === routeId) {
                    route = state.routes[i];
                    break;
                }
            }
            
            if (!route) {
                console.log('Route not found:', routeId);
                return;
            }
            
            console.log('Starting navigation:', route.name);
            
            // Generate turn-by-turn directions
            state.currentDirections = generateDirections(route, state.destination);
            state.currentStep = 0;
            
            // Update current app state
            state.isNavigating = true;
            state.selectedRoute = route;
            
            // Show navigation status
            var navStatus = document.getElementById('nav-status');
            navStatus.classList.remove('hidden');
            navStatus.innerHTML = 
                '<div>' +
                    '<div style="font-weight: bold;">Navigating: ' + route.name + '</div>' +
                    '<div style="font-size: 0.9rem;">' + route.distance + ' ‚Ä¢ ' + route.duration + ' ‚Ä¢ Max: ' + route.maxElevation + ' ft</div>' +
                '</div>' +
                '<div style="display: flex; gap: 0.5rem;">' +
                    '<button onclick="nextDirection()" style="background: #16a34a; padding: 0.5rem 1rem;">Next Turn</button>' +
                    '<button onclick="stopNavigation()" style="background: #dc2626; padding: 0.5rem 1rem;">Stop</button>' +
                '</div>';
            
            // Show turn-by-turn directions
            displayDirections();
            
            // Scroll to top to show the route on map
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function nextDirection() {
            if (!state.currentDirections || state.currentStep >= state.currentDirections.length - 1) {
                alert('üèÅ Navigation Complete!\n\nYou have arrived at your destination safely.');
                stopNavigation();
                return;
            }
            
            state.currentStep++;
            var direction = state.currentDirections[state.currentStep];
            
            // Update elevation
            state.currentLocation.elevation = direction.elevation;
            updateElevationDisplay();
            updateMapLocation();
            
            // Check for elevation warnings
            if (direction.elevation > state.elevationThreshold) {
                var elevationZone = getElevationZoneName(direction.elevation);
                alert('üö® ELEVATION WARNING!\n\n' +
                    'Current elevation: ' + direction.elevation + ' ft\n' +
                    'Your safe limit: ' + state.elevationThreshold + ' ft\n' +
                    'Zone: ' + elevationZone + '\n\n' +
                    '‚ö†Ô∏è Consider taking a break or seeking lower elevation.\n' +
                    'üí® Monitor your breathing carefully.');
            }
            
            // Update directions display to show progress
            displayDirections();
            
            // Scroll to current step
            setTimeout(function() {
                var currentStepEl = document.querySelector('[style*="border-left: 4px solid #2563eb"]');
                if (currentStepEl) {
                    currentStepEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        function displayDirections() {
            var directionsSection = document.getElementById('directions-section');
            var container = document.getElementById('directions-container');
            
            if (!state.currentDirections) return;
            
            var route = state.selectedRoute;
            
            var html = '<div style="background: #f0fdf4; border: 2px solid #16a34a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
                '<h4>' + route.name + ' - Turn-by-Turn Navigation</h4>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem; font-size: 0.9rem;">' +
                    '<div><strong>Total Distance:</strong> ' + route.distance + '</div>' +
                    '<div><strong>Estimated Time:</strong> ' + route.duration + '</div>' +
                    '<div><strong>Max Elevation:</strong> ' + route.maxElevation + ' ft</div>' +
                    '<div><strong>Route Type:</strong> ' + getRouteTypeDescription(route.routeType) + '</div>' +
                '</div>' +
                '</div>';
            
            if (route.maxElevation > state.elevationThreshold) {
                html += '<div style="background: #fef2f2; border: 2px solid #dc2626; color: #dc2626; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-weight: bold;">' +
                    'WARNING: This route reaches ' + route.maxElevation + ' ft elevation, which exceeds your safe limit of ' + state.elevationThreshold + ' ft. Consider taking breaks or choosing the Lowest Elevation Route.' +
                    '</div>';
            }
            
            // Add current position indicator if navigating
            if (state.isNavigating && state.currentStep < state.currentDirections.length) {
                var currentDirection = state.currentDirections[state.currentStep];
                html += '<div style="background: #2563eb; color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
                    '<div style="display: flex; align-items: center; gap: 1rem;">' +
                        '<div style="font-size: 2rem;">üß≠</div>' +
                        '<div>' +
                            '<div style="font-weight: bold; font-size: 1.1rem;">CURRENT: ' + currentDirection.instruction + '</div>' +
                            '<div style="font-size: 0.9rem; opacity: 0.9;">' + currentDirection.details + '</div>' +
                            '<div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.9rem;">' +
                                '<span>üìè ' + currentDirection.distance + '</span>' +
                                '<span>‚è±Ô∏è ' + currentDirection.estimatedTime + '</span>' +
                                '<span style="color: ' + getElevationColor(currentDirection.elevation) + ';">‚õ∞Ô∏è ' + currentDirection.elevation + ' ft</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }
            
            for (var i = 0; i < state.currentDirections.length; i++) {
                var direction = state.currentDirections[i];
                var isCurrentStep = i === state.currentStep && state.isNavigating;
                var isCompleted = i < state.currentStep && state.isNavigating;
                var elevationColor = getElevationColor(direction.elevation);
                var elevationZone = getElevationZoneName(direction.elevation);
                
                var stepBackgroundColor = '';
                var stepTextColor = '#333';
                var stepBorderLeft = '';
                
                if (isCurrentStep) {
                    stepBackgroundColor = '#eff6ff';
                    stepBorderLeft = '4px solid #2563eb';
                } else if (isCompleted) {
                    stepBackgroundColor = '#f0fdf4';
                    stepBorderLeft = '4px solid #16a34a';
                    stepTextColor = '#6b7280';
                }
                
                var directionIcon = getDirectionIcon(direction.instruction);
                
                html += '<div style="display: flex; padding: 1rem; border-bottom: 1px solid #e5e7eb; ' + 
                    'background: ' + stepBackgroundColor + '; ' + stepBorderLeft + '; color: ' + stepTextColor + ';">' +
                    '<div style="background: ' + (isCurrentStep ? '#2563eb' : isCompleted ? '#16a34a' : '#6b7280') + '; color: white; width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 1rem; font-size: 0.9rem;">' + 
                        (isCompleted ? '‚úì' : direction.step) + 
                    '</div>' +
                    '<div style="flex: 1;">' +
                        '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">' +
                            '<span style="font-size: 1.2rem;">' + directionIcon + '</span>' +
                            '<div style="font-weight: bold; font-size: 1rem;">' + direction.instruction + '</div>' +
                        '</div>' +
                        '<div style="color: #6b7280; font-size: 0.9rem; margin: 0.25rem 0;">' + direction.details + '</div>' +
                        '<div style="display: flex; gap: 1rem; font-size: 0.9rem; flex-wrap: wrap;">' +
                            '<span style="color: #2563eb; font-weight: 500;">üìè ' + direction.distance + '</span>' +
                            '<span style="color: #059669; font-weight: 500;">‚è±Ô∏è ' + direction.estimatedTime + '</span>' +
                            '<span style="color: ' + elevationColor + '; font-weight: 500;">‚õ∞Ô∏è ' + direction.elevation + ' ft</span>' +
                            '<span style="color: ' + elevationColor + '; font-size: 0.8rem;">(' + elevationZone + ')</span>' +
                        '</div>' +
                        (direction.elevation > state.elevationThreshold ? 
                            '<div style="background: #fef2f2; color: #dc2626; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.8rem; font-weight: bold;">‚ö†Ô∏è Above your safe elevation limit</div>' : '') +
                    '</div>' +
                '</div>';
            }
            
            container.innerHTML = html;
            directionsSection.classList.remove('hidden');
        }

        function getRouteTypeDescription(routeType) {
            switch(routeType) {
                case 'low_elevation': return 'Valley Roads';
                case 'fastest': return 'Highway/Interstate';
                case 'balanced': return 'Scenic Route';
                default: return 'Mixed Roads';
            }
        }

        function getDirectionIcon(instruction) {
            var lowerInstruction = instruction.toLowerCase();
            
            if (lowerInstruction.includes('left')) return '‚Ü∞';
            if (lowerInstruction.includes('right')) return '‚Ü±';
            if (lowerInstruction.includes('straight') || lowerInstruction.includes('continue')) return '‚Üë';
            if (lowerInstruction.includes('merge')) return 'üõ£Ô∏è';
            if (lowerInstruction.includes('exit')) return 'üõ§Ô∏è';
            if (lowerInstruction.includes('arrive')) return 'üèÅ';
            if (lowerInstruction.includes('head')) return 'üß≠';
            if (lowerInstruction.includes('fork') || lowerInstruction.includes('bear')) return 'üç¥';
            if (lowerInstruction.includes('descent') || lowerInstruction.includes('descend')) return '‚ÜòÔ∏è';
            
            return '‚û°Ô∏è';
        }

        function printDirections() {
            if (!state.currentDirections || !state.selectedRoute) {
                alert('No directions to print. Please start navigation first.');
                return;
            }
            
            var route = state.selectedRoute;
            var printContent = '<!DOCTYPE html><html><head><title>Directions: ' + route.name + '</title>' +
                '<style>body{font-family:Arial,sans-serif;margin:20px;}h1{color:#2563eb;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background:#f2f2f2;}.warning{background:#ffebee;border:2px solid #f44336;padding:10px;margin:10px 0;color:#d32f2f;}</style>' +
                '</head><body>' +
                '<h1>Elevation Navigation: ' + route.name + '</h1>' +
                '<p><strong>Destination:</strong> ' + state.destination + '</p>' +
                '<p><strong>Distance:</strong> ' + route.distance + ' | <strong>Duration:</strong> ' + route.duration + '</p>' +
                '<p><strong>Max Elevation:</strong> ' + route.maxElevation + ' ft | <strong>Elevation Gain:</strong> ' + route.elevationGain + ' ft</p>';
            
            if (route.maxElevation > state.elevationThreshold) {
                printContent += '<div class="warning"><strong>ELEVATION WARNING:</strong> This route exceeds your safe elevation limit of ' + state.elevationThreshold + ' ft. Monitor breathing and take breaks as needed.</div>';
            }
            
            printContent += '<table><tr><th>Step</th><th>Instruction</th><th>Distance</th><th>Time</th><th>Elevation</th></tr>';
            
            for (var i = 0; i < state.currentDirections.length; i++) {
                var direction = state.currentDirections[i];
                printContent += '<tr>' +
                    '<td>' + direction.step + '</td>' +
                    '<td>' + direction.instruction + '<br><small>' + direction.details + '</small></td>' +
                    '<td>' + direction.distance + '</td>' +
                    '<td>' + direction.estimatedTime + '</td>' +
                    '<td style="' + (direction.elevation > state.elevationThreshold ? 'color:red;font-weight:bold;' : '') + '">' + direction.elevation + ' ft</td>' +
                '</tr>';
            }
            
            printContent += '</table><p style="margin-top:20px;"><strong>Important:</strong> Monitor your breathing throughout the journey. If you experience difficulty breathing, stop and seek lower elevation immediately.</p></body></html>';
            
            var printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function generateDirections(route, destination) {
            var directions = [];
            
            // Generate directions based on the selected route type
            if (route.routeType === 'low_elevation') {
                directions = generateLowElevationDirections(route, destination);
            } else if (route.routeType === 'fastest') {
                directions = generateFastestRouteDirections(route, destination);
            } else {
                directions = generateBalancedRouteDirections(route, destination);
            }
            
            return directions;
        }

        function generateLowElevationDirections(route, destination) {
            return [
                { step: 1, instruction: "Head north on local surface streets", distance: "0.4 mi", elevation: 285, details: "Start from your current location avoiding highways", estimatedTime: "2 min" },
                { step: 2, instruction: "Turn right onto Valley View Road", distance: "2.8 mi", elevation: 320, details: "Follow Valley View Road through residential area", estimatedTime: "6 min" },
                { step: 3, instruction: "Continue straight on Old Ranch Road", distance: "8.2 mi", elevation: 380, details: "Stay on Old Ranch Road, avoiding highway on-ramps", estimatedTime: "18 min" },
                { step: 4, instruction: "Turn left onto River Valley Drive", distance: "12.5 mi", elevation: 450, details: "Winding road through canyon following the river", estimatedTime: "28 min" },
                { step: 5, instruction: "Bear right at fork to stay on Lower Canyon Road", distance: "9.7 mi", elevation: 680, details: "Take the lower fork to avoid steep mountain climb", estimatedTime: "22 min" },
                { step: 6, instruction: "Turn right onto Meadowbrook Lane", distance: "6.3 mi", elevation: 920, details: "Rural road through valley meadows", estimatedTime: "14 min" },
                { step: 7, instruction: "Continue on Foothill Boulevard", distance: "8.9 mi", elevation: 1100, details: "Follow foothills staying below major peaks", estimatedTime: "20 min" },
                { step: 8, instruction: "Turn left onto Creek Side Road", distance: "4.2 mi", elevation: 950, details: "Descent following creek bed", estimatedTime: "9 min" },
                { step: 9, instruction: "Turn right onto destination street", distance: "1.8 mi", elevation: 850, details: "Final approach through local neighborhoods", estimatedTime: "4 min" },
                { step: 10, instruction: "Arrive at " + destination, distance: "0.2 mi", elevation: 820, details: "You have reached your destination", estimatedTime: "1 min" }
            ];
        }

        function generateFastestRouteDirections(route, destination) {
            return [
                { step: 1, instruction: "Head to highway entrance ramp", distance: "0.3 mi", elevation: 285, details: "Navigate to nearest highway access point", estimatedTime: "1 min" },
                { step: 2, instruction: "Merge onto I-405 North", distance: "1.2 mi", elevation: 350, details: "Take I-405 North on-ramp, accelerate to highway speed", estimatedTime: "2 min" },
                { step: 3, instruction: "Continue on I-405 North for 18 miles", distance: "18.4 mi", elevation: 800, details: "Stay in right lanes, moderate traffic expected", estimatedTime: "16 min" },
                { step: 4, instruction: "Take Exit 47B for SR-14 North", distance: "0.8 mi", elevation: 1200, details: "Take the SR-14 North exit toward mountain regions", estimatedTime: "2 min" },
                { step: 5, instruction: "Merge onto SR-14 North (Antelope Valley Freeway)", distance: "22.1 mi", elevation: 2800, details: "Major highway through mountain pass - elevation climbing", estimatedTime: "19 min" },
                { step: 6, instruction: "Take Exit 28 for Mountain View Road", distance: "1.1 mi", elevation: 4200, details: "WARNING: High elevation area - monitor breathing", estimatedTime: "2 min" },
                { step: 7, instruction: "Continue on Mountain View Road", distance: "8.7 mi", elevation: 5800, details: "CAUTION: Peak elevation section - consider rest stops", estimatedTime: "12 min" },
                { step: 8, instruction: "Turn right onto Summit Drive", distance: "3.4 mi", elevation: 6200, details: "Highest point of journey - take breaks if needed", estimatedTime: "6 min" },
                { step: 9, instruction: "Begin descent on Highland Avenue", distance: "6.2 mi", elevation: 4800, details: "Steep descent from mountain pass", estimatedTime: "8 min" },
                { step: 10, instruction: "Turn left onto destination boulevard", distance: "2.3 mi", elevation: 3200, details: "Final approach to destination area", estimatedTime: "4 min" },
                { step: 11, instruction: "Arrive at " + destination, distance: "0.4 mi", elevation: 2900, details: "You have reached your destination", estimatedTime: "1 min" }
            ];
        }

        function generateBalancedRouteDirections(route, destination) {
            return [
                { step: 1, instruction: "Head northwest on Main Street", distance: "0.5 mi", elevation: 285, details: "Start from current location toward scenic route", estimatedTime: "2 min" },
                { step: 2, instruction: "Turn right onto Coastal Highway 1", distance: "12.3 mi", elevation: 420, details: "Beautiful coastal views with moderate elevation", estimatedTime: "22 min" },
                { step: 3, instruction: "Continue straight through Malibu", distance: "8.6 mi", elevation: 380, details: "Follow PCH through coastal communities", estimatedTime: "16 min" },
                { step: 4, instruction: "Turn left onto Topanga Canyon Boulevard", distance: "6.8 mi", elevation: 850, details: "Winding canyon road with gradual elevation gain", estimatedTime: "14 min" },
                { step: 5, instruction: "Bear right onto Mulholland Drive", distance: "9.2 mi", elevation: 1400, details: "Scenic ridge road with panoramic views", estimatedTime: "18 min" },
                { step: 6, instruction: "Take slight left onto Laurel Canyon Boulevard", distance: "4.7 mi", elevation: 1100, details: "Descent through Hollywood Hills", estimatedTime: "10 min" },
                { step: 7, instruction: "Turn right onto Ventura Boulevard", distance: "7.8 mi", elevation: 650, details: "Major east-west arterial through valley", estimatedTime: "15 min" },
                { step: 8, instruction: "Continue on Ventura Blvd for 5 miles", distance: "5.1 mi", elevation: 580, details: "Stay on Ventura through Sherman Oaks", estimatedTime: "12 min" },
                { step: 9, instruction: "Turn left onto Reseda Boulevard", distance: "3.9 mi", elevation: 720, details: "Head north through suburban neighborhoods", estimatedTime: "8 min" },
                { step: 10, instruction: "Turn right onto destination street", distance: "2.2 mi", elevation: 680, details: "Final approach to destination", estimatedTime: "5 min" },
                { step: 11, instruction: "Arrive at " + destination, distance: "0.3 mi", elevation: 650, details: "You have reached your destination", estimatedTime: "1 min" }
            ];
        }

        function stopNavigation() {
            console.log('Stopping navigation');
            state.isNavigating = false;
            state.currentDirections = null;
            state.currentStep = 0;
            document.getElementById('nav-status').classList.add('hidden');
            document.getElementById('directions-section').classList.add('hidden');
        }

        // Start the app
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);

function dismissAlert() {
    document.getElementById('elevation-alert').classList.add('hidden');
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
