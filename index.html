<!-- tweaked COPD-safe route logic -->
<script>
  // ... [unchanged map and geocode setup]

  async function getRoutes() {
    clearMap();
    const start = await geocode(document.getElementById("startPlace").value);
    const end = await geocode(document.getElementById("endPlace").value);
    const safeMode = document.getElementById("safeMode").checked;

    const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?alternatives=true&overview=full&geometries=geojson`;
    const res = await fetch(url);
    const data = await res.json();
    const routes = data.routes.slice(0, 3);

    let bestIndex = 0;
    let bestScore = Infinity;
    const baseDuration = routes[0].duration;
    const maxDuration = baseDuration + (8 * 3600);

    for (let i = 0; i < routes.length; i++) {
      const route = routes[i];
      const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
      const poly = L.polyline(coords, {
        color: routeColors[i], weight: 5, opacity: 0.7
      }).addTo(map);

      poly.routeData = { coords, index: i, route };
      poly.on('click', () => selectRoute(poly));
      routeLayers.push(poly);

      const elevations = await fetchElevations(coords, 2000);
      const gain = totalElevationGain(elevations);
      const maxElev = maxElevation(elevations);

      poly.routeData.elevations = elevations;
      poly.routeData.gain = gain;
      poly.routeData.maxElevation = maxElev;

      if (safeMode) {
        const durationPenalty = route.duration > maxDuration ? 1e6 : 0;
        const score = maxElev + gain + durationPenalty;
        if (score < bestScore) {
          bestScore = score;
          bestIndex = i;
        }
      } else if (i === 0) bestIndex = 0;
    }

    map.fitBounds(routeLayers[bestIndex].getBounds());
    selectRoute(routeLayers[bestIndex]);
  }

  function maxElevation(elevations) {
    return Math.max(...elevations);
  }

  function selectRoute(poly) {
    dangerOverlays.forEach(layer => map.removeLayer(layer));
    dangerOverlays = [];

    const { coords, elevations, route, gain, maxElevation } = poly.routeData;
    const dangerSegments = findDangerSegments(coords, elevations);

    for (const [i, j] of dangerSegments) {
      const danger = L.polyline(coords.slice(i, j + 1), {
        color: "red", weight: 6, opacity: 1
      }).addTo(map);
      dangerOverlays.push(danger);
    }

    const dist = Math.round(route.distance / 1000);
    const time = Math.round(route.duration / 60);
    const elevDanger = maxElevation > 1500 ? "<span class='danger'>⚠️ High elevation detected!</span>" : "✅ Low altitude";

    document.getElementById("info").innerHTML = `
      <b>Selected Route:</b><br>
      Distance: ${dist} km<br>
      Duration: ${time} min<br>
      Elevation Gain: ${Math.round(gain)} meters<br>
      Max Elevation: ${Math.round(maxElevation)} meters<br>
      ${dangerSegments.length ? "<span class='danger'>⚠️ Steep segments detected!</span><br>" : "✅ Gentle slope<br>"}
      ${elevDanger}
    `;
  }
</script>
